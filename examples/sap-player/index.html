<html>

<head>
    <!--
        This example is based on https://mimuma.pl/pokeyzaur/app.js player created by bocianu
    -->
    <title>Web POKEY - SapR Player</title>
    <script src='https://code.jquery.com/jquery-latest.min.js' type='text/javascript'></script>
    <script type="module">
        import { createAnalyser } from './analyser.js'
        import { SAPPlayer} from './sap.js'
        const reg_names = ["audf1", "audc1", "audf2", "audc2", "audf3", "audc3", "audf4", "audc4", "audctl"];

        function get_sample_rate() {
            return parseInt(localStorage.sampleRate || 44100)
        }

        async function init(latencyHint) {
            var latencyHint = parseFloat(localStorage.latencyHint);
            if(!(latencyHint >=0 )) latencyHint = localStorage.latencyHint || "playback";
            let audioContextParams = {
                sampleRate: get_sample_rate(),
                latencyHint,
            }
            const audioContext = new AudioContext(audioContextParams)
            console.info("created audioContext with:", audioContextParams)

            document.addEventListener('visibilitychange', function() {
                if (document.hidden) {
                    audioContext.suspend();
                } else {
                    audioContext.resume();
                }
            });

            $("#latency").text(audioContext.baseLatency)

            $("select.sample_rate").val(get_sample_rate()).change((e) => {
                let val = $(e.target).val()
                console.log(val)
                localStorage.sampleRate = val
                window.location.reload(true)
            })

            await audioContext.audioWorklet.addModule('../../pokey.js')
            const pokeyNode = new AudioWorkletNode(audioContext, 'POKEY')
            var analyser = createAnalyser(audioContext);
            analyser.node.connect(audioContext.destination);
            // pokeyNode.connect(audioContext.destination)
            pokeyNode.connect(analyser.node);

            let sapPlayer = new SAPPlayer(audioContext, pokeyNode);
            window.sapPlayer = sapPlayer;
            function play_url(url) {
                if(url.startsWith("http://") || url.startsWith("https://")) {
                    url = "https://atari.ha.sed.pl/" + url
                }
                fetch(url)
                    .then(response => response.arrayBuffer())
                    .then(buffer => {
                        let is_ok = sapPlayer.load(buffer);
                        $("#sap_error").text(sapPlayer.error_message);
                        let headers = $("#sap_headers").text(sapPlayer.raw_headers)
                    }).catch(err => {
                        $("#sap_error").text(err);
                    })
            }

            function send_regs() {
                audioContext.resume();
                let t = audioContext.currentTime + 0.05;
                let msg = reg_names.map(get_reg).flatMap((v, i) => [i, v, t])
                pokeyNode.port.postMessage(msg);
            }

            function get_reg(name) {
                let input = document.querySelector("#" + name);
                return parseInt(input.value, 16) || 0;
            }

            function set_reg(name, value) {
                let input = document.querySelector("#" + name);
                input.value = value
            }
            function hash_changed() {
                let hash = document.location.hash.substring(1);
                if(hash) {
                    play_url(hash);
                }
            }

            function hex2(value) {
                if (value < 0) value = 0;
                if (value > 255) value = 255;
                var hex = value.toString(16);
                if (hex.length < 2) {
                    hex = "0" + hex;
                }
                return hex;
            }

            $("#latency-hint").change(e => {
                localStorage['latencyHint'] = e.target.value;
            }).val(localStorage['latencyHint'] || 'playback');
            $('#ua').text(window.navigator.userAgent);
            $('#pokey_regs input').change(send_regs);
            $('body').click(() => {
                sapPlayer.audio_context.resume();
            })
            $(window).bind("hashchange", hash_changed);

            let seek = $('#player .seek').bind('input', event => sapPlayer.seek(event.target.value));
            let position_info = $('#player .position-info');

            $('#player .play').click(() => sapPlayer.play());
            $('#player .pause').click(() => sapPlayer.pause());
            $('#player .stop').click(() => sapPlayer.stop());
            $('#player .prev').click(() => sapPlayer.prev());
            $('#player .next').click(() => sapPlayer.next());

            $(window).bind("sap_player", event => {
                let data = event.originalEvent.data;
                if(data.pokey_regs) {
                    let regs = Array.from(data.pokey_regs);
                    regs.slice(0, 9).map(hex2).map((v, i) => {
                        set_reg(reg_names[i], v);
                    })
                }
                seek[0].max = data.frame_cnt > 0 ? data.frame_cnt - 1 : 0;
                seek.val(data.current_frame);
                position_info.text(`${data.current_frame} / ${data.frame_cnt}`)
            });

            let tick = () => {
                sapPlayer.tick();
                analyser.draw();
                requestAnimationFrame(tick);
            }
            tick();
            hash_changed();
        }

        init("playback");

    </script>
    <style>
        #player > * {
            margin: 1em;
        }
        #player input[type=range] {
            margin: 0 1em;
        }
        #pokey_regs input {
            width: 3em;
        }
        #pokey_regs {
            float: left;
            margin: 1em;
        }

        #sap_error {
            color: red;
            font-weight: bold;
        }
        .debug {
            color: gray;
        }
    </style>
</head>

<body>
    <div style="position: relative">
    <table id="pokey_regs">
        <tr>
            <td></td>
            <td>AUDF</td>
            <td>AUDC</td>
        </tr>
        <tr>
            <td>channel 1</td>
            <td><input id="audf1" value="00" /></td>
            <td><input id="audc1" value="00" /></td>
        </tr>
        <tr>
            <td>channel 2</td>
            <td><input id="audf2" value="00" /></td>
            <td><input id="audc2" value="00" /></td>
        </tr>
        <tr>
            <td>channel 3</td>
            <td><input id="audf3" value="00" /></td>
            <td><input id="audc3" value="00" /></td>
        </tr>
        <tr>
            <td>channel 4</td>
            <td><input id="audf4" value="00" /></td>
            <td><input id="audc4" value="00" /></td>
        </tr>
        <tr>
            <td>AUDCTL</td>
            <td><input id="audctl" value="00" /></td>
        </tr>
    </table>

    <div style="float: left">
        <pre id="sap_headers"></pre>
        <div id="sap_error"></div>
    </div>
</div>

    <br />
    <div id="player" style="width: 1024px">
        <canvas id="oscilloscope" width="1024" height="256"></canvas>
        <input type="range" style="width: 100%" class="seek" max="0", value="0" />
        <div>
            <button class="prev">&lt;&lt;</button>
            <button class="play">play</button>
            <button class="pause">pause</button>
            <button class="stop">stop</button>
            <button class="next">&gt;&gt;</button>
            <label class="position-info"></label>
        </div>
    </div>
    sample rate: <select class="sample_rate">
        <option value="44100">44100</option>
        <option value="48000">48000</option>
        <option value="56000">56000</option>
    </select>
    latency hint: <input id="latency-hint" value="playback" />
    <div class="debug">
        <p>Latency: <span id="latency"></span></p>
        <p>UserAgent: <span id="ua"></span></p>
    </div>
</body>

</html>